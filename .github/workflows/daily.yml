name: Daily NBA Dashboard Refresh

on:
  schedule:
    - cron: "0 12 * * *"       # 7:00 AM ET (12:00 UTC)
  workflow_dispatch:           # allow manual runs
  push:
    paths:
      - "*.py"
      - "nba_master.csv"

jobs:
  run-refresh:
    runs-on: ubuntu-latest

    permissions:
      contents: write          # required for pushing to gh-pages

    steps:

      # -------------------------------------------------------------
      # CHECKOUT MAIN BRANCH
      # -------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------------
      # PYTHON SETUP
      # -------------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests

      # -------------------------------------------------------------
      # INGEST + BUILD DASHBOARD
      # -------------------------------------------------------------
      - name: Run ingest script
        run: |
          echo "Running ESPN ingest…"
          python espn_daily_ingest.py --out nba_master.csv
          echo "Ingest complete."

      - name: Build dashboard
        run: |
          echo "Building dashboard…"
          python build_dashboard.py
          echo "Dashboard built successfully."

      # -------------------------------------------------------------
      # SAVE GENERATED FILES BEFORE BRANCH SWITCH
      # -------------------------------------------------------------
      - name: Save dashboard artifacts
        run: |
          FILE=$(ls dashboard_*.html | head -n 1)
          if [ -z "$FILE" ]; then
            echo "ERROR: No dashboard HTML generated!"
            exit 1
          fi

          echo "Saving artifacts to /tmp/"
          cp "$FILE" /tmp/index.html
          cp nba_master.csv /tmp/nba_master.csv

      # -------------------------------------------------------------
      # DEPLOY TO GH-PAGES (CLEAN + SAFE)
      # -------------------------------------------------------------
      - name: Deploy to gh-pages
        run: |
          echo "Configuring git identity…"
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          echo "Fetching gh-pages branch…"
          git fetch origin gh-pages || true

          echo "Switching to gh-pages…"
          git switch gh-pages || git switch --orphan gh-pages

          echo "Clearing old published files…"
          git rm -rf . || true

          echo "Restoring new dashboard files…"
          cp /tmp/index.html index.html
          cp /tmp/nba_master.csv nba_master.csv

          echo "Creating commit…"
          git add index.html nba_master.csv
          git commit -m "Automated dashboard update $(date -u +'%Y-%m-%d %H:%M:%S')" || true

          echo "Pushing to gh-pages…"
          git push origin gh-pages --force

      # -------------------------------------------------------------
      # OPTIONAL: BACKUP TO MAIN BRANCH (RETENTION)
      # -------------------------------------------------------------
      - name: Backup dashboard in /_backups
        run: |
          mkdir -p _backups
          cp /tmp/index.html "_backups/dashboard_$(date -u +'%Y-%m-%d').html"
          git add _backups || true
          git commit -m "Backup dashboard $(date -u +'%Y-%m-%d')" || true
          git push origin main || true